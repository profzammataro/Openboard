<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Openboard - Lavagna Collaborativa</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, onValue, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDgP68PiltXq4Az_kmJUDkuIQfejjwAIxs",
            authDomain: "openboard-a417d.firebaseapp.com",
            databaseURL: "https://openboard-a417d-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "openboard-a417d",
            storageBucket: "openboard-a417d.firebasestorage.app",
            messagingSenderId: "756032129197",
            appId: "1:756032129197:web:5e111c1fdbde5eea6f5e24"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        window.firebaseDB = { database, ref, onValue, set };
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        const Openboard = () => {
            const [groups] = useState([
                { id: 1, name: 'Gruppo 1', color: 'bg-red-500' },
                { id: 2, name: 'Gruppo 2', color: 'bg-blue-500' },
                { id: 3, name: 'Gruppo 3', color: 'bg-green-500' },
                { id: 4, name: 'Gruppo 4', color: 'bg-yellow-500' },
                { id: 5, name: 'Gruppo 5', color: 'bg-purple-500' },
                { id: 6, name: 'Gruppo 6', color: 'bg-pink-500' }
            ]);
            
            const [ideas, setIdeas] = useState({});
            const [selectedGroup, setSelectedGroup] = useState(null);
            const [showAllIdeas, setShowAllIdeas] = useState(false);
            const [newIdea, setNewIdea] = useState('');
            const [drawingMode, setDrawingMode] = useState(false);
            const [drawings, setDrawings] = useState({});
            const [isOnline, setIsOnline] = useState(false);
            
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [currentDrawing, setCurrentDrawing] = useState([]);

            useEffect(() => {
                if (window.firebaseDB) {
                    const { database, ref, onValue } = window.firebaseDB;
                    
                    const ideasRef = ref(database, 'ideas');
                    onValue(ideasRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setIdeas(data);
                        }
                    });

                    const drawingsRef = ref(database, 'drawings');
                    onValue(drawingsRef, (snapshot) => {
                        const data = snapshot.val();
                        if (data) {
                            setDrawings(data);
                        }
                    });

                    setIsOnline(true);
                }
            }, []);

            useEffect(() => {
                if (drawingMode && canvasRef.current) {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                }
            }, [drawingMode]);

            const addIdea = async () => {
                if (newIdea.trim() && selectedGroup && window.firebaseDB) {
                    const groupIdeas = ideas[selectedGroup] || [];
                    const newIdeaObj = { text: newIdea, id: Date.now() };
                    const updatedIdeas = {
                        ...ideas,
                        [selectedGroup]: [...groupIdeas, newIdeaObj]
                    };
                    
                    try {
                        const { database, ref, set } = window.firebaseDB;
                        await set(ref(database, 'ideas'), updatedIdeas);
                        setNewIdea('');
                    } catch (error) {
                        console.error('Error adding idea:', error);
                    }
                }
            };

            const deleteIdea = async (groupId, ideaId) => {
                if (window.firebaseDB) {
                    const updatedIdeas = {
                        ...ideas,
                        [groupId]: ideas[groupId].filter(idea => idea.id !== ideaId)
                    };
                    
                    try {
                        const { database, ref, set } = window.firebaseDB;
                        await set(ref(database, 'ideas'), updatedIdeas);
                    } catch (error) {
                        console.error('Error deleting idea:', error);
                    }
                }
            };

            const startDrawing = (e) => {
                if (!drawingMode) return;
                setIsDrawing(true);
                const canvas = canvasRef.current;
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
                const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                setCurrentDrawing([{ x, y }]);
            };

            const draw = (e) => {
                if (!isDrawing || !drawingMode) return;
                e.preventDefault();
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                const rect = canvas.getBoundingClientRect();
                const x = (e.clientX || e.touches?.[0]?.clientX) - rect.left;
                const y = (e.clientY || e.touches?.[0]?.clientY) - rect.top;
                
                const newPoint = { x, y };
                setCurrentDrawing(prev => [...prev, newPoint]);
                
                if (currentDrawing.length > 0) {
                    const lastPoint = currentDrawing[currentDrawing.length - 1];
                    ctx.beginPath();
                    ctx.moveTo(lastPoint.x, lastPoint.y);
                    ctx.lineTo(x, y);
                    ctx.stroke();
                }
            };

            const stopDrawing = async () => {
                if (isDrawing && currentDrawing.length > 0 && window.firebaseDB) {
                    const viewKey = showAllIdeas ? 'all' : selectedGroup;
                    const updatedDrawings = {
                        ...drawings,
                        [viewKey]: [...(drawings[viewKey] || []), currentDrawing]
                    };
                    
                    try {
                        const { database, ref, set } = window.firebaseDB;
                        await set(ref(database, 'drawings'), updatedDrawings);
                    } catch (error) {
                        console.error('Error saving drawing:', error);
                    }
                }
                setIsDrawing(false);
                setCurrentDrawing([]);
            };

            const clearDrawings = async () => {
                if (window.firebaseDB) {
                    const viewKey = showAllIdeas ? 'all' : selectedGroup;
                    const updatedDrawings = {
                        ...drawings,
                        [viewKey]: []
                    };
                    
                    try {
                        const { database, ref, set } = window.firebaseDB;
                        await set(ref(database, 'drawings'), updatedDrawings);
                        
                        if (canvasRef.current) {
                            const ctx = canvasRef.current.getContext('2d');
                            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
                        }
                    } catch (error) {
                        console.error('Error clearing drawings:', error);
                    }
                }
            };

            useEffect(() => {
                if (canvasRef.current) {
                    const canvas = canvasRef.current;
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    const viewKey = showAllIdeas ? 'all' : selectedGroup;
                    const viewDrawings = drawings[viewKey] || [];
                    
                    ctx.strokeStyle = '#ef4444';
                    ctx.lineWidth = 3;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    
                    viewDrawings.forEach(line => {
                        if (line.length > 1) {
                            ctx.beginPath();
                            ctx.moveTo(line[0].x, line[0].y);
                            for (let i = 1; i < line.length; i++) {
                                ctx.lineTo(line[i].x, line[i].y);
                            }
                            ctx.stroke();
                        }
                    });
                }
            }, [drawings, showAllIdeas, selectedGroup]);

            const renderGroupView = () => {
                const group = groups.find(g => g.id === selectedGroup);
                const groupIdeas = ideas[selectedGroup] || [];

                return (
                    <div className="flex-1 p-6">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold flex items-center gap-3">
                                <span className={`w-6 h-6 rounded-full ${group.color}`}></span>
                                {group.name}
                            </h2>
                            <button
                                onClick={() => setShowAllIdeas(true)}
                                className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                Vedi tutte le idee
                            </button>
                        </div>

                        <div className="mb-6 flex gap-2">
                            <input
                                type="text"
                                value={newIdea}
                                onChange={(e) => setNewIdea(e.target.value)}
                                onKeyPress={(e) => e.key === 'Enter' && addIdea()}
                                placeholder="Scrivi una nuova idea..."
                                className="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                            />
                            <button
                                onClick={addIdea}
                                className="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition flex items-center gap-2"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="M12 5v14"/></svg>
                                Aggiungi
                            </button>
                        </div>

                        <div className="grid gap-3">
                            {groupIdeas.map((idea) => (
                                <div
                                    key={idea.id}
                                    className="p-4 bg-white border-2 border-gray-200 rounded-lg shadow-sm hover:shadow-md transition flex justify-between items-center"
                                >
                                    <span className="text-lg">{idea.text}</span>
                                    <button
                                        onClick={() => deleteIdea(selectedGroup, idea.id)}
                                        className="text-red-500 hover:text-red-700 p-2"
                                    >
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
                                    </button>
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            const renderAllIdeasView = () => {
                return (
                    <div className="flex-1 p-6 relative">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-3xl font-bold">Tutte le Idee</h2>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setDrawingMode(!drawingMode)}
                                    className={`flex items-center gap-2 px-4 py-2 rounded-lg transition ${
                                        drawingMode ? 'bg-red-600 text-white' : 'bg-gray-600 text-white hover:bg-gray-700'
                                    }`}
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></svg>
                                    {drawingMode ? 'Disattiva Penna' : 'Attiva Penna'}
                                </button>
                                {drawingMode && (
                                    <button
                                        onClick={clearDrawings}
                                        className="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition"
                                    >
                                        Cancella Disegni
                                    </button>
                                )}
                                <button
                                    onClick={() => setShowAllIdeas(false)}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition"
                                >
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                                    Chiudi
                                </button>
                            </div>
                        </div>

                        <div className="relative">
                            <div className="grid grid-cols-2 gap-6">
                                {groups.map(group => {
                                    const groupIdeas = ideas[group.id] || [];
                                    return (
                                        <div key={group.id} className="bg-white rounded-lg border-2 border-gray-200 p-4">
                                            <h3 className="text-xl font-bold mb-3 flex items-center gap-2">
                                                <span className={`w-4 h-4 rounded-full ${group.color}`}></span>
                                                {group.name}
                                            </h3>
                                            <div className="space-y-2">
                                                {groupIdeas.map(idea => (
                                                    <div key={idea.id} className="p-3 bg-gray-50 rounded border border-gray-200">
                                                        {idea.text}
                                                    </div>
                                                ))}
                                                {groupIdeas.length === 0 && (
                                                    <div className="text-gray-400 italic">Nessuna idea ancora</div>
                                                )}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>

                            {drawingMode && (
                                <canvas
                                    ref={canvasRef}
                                    width={1200}
                                    height={800}
                                    onMouseDown={startDrawing}
                                    onMouseMove={draw}
                                    onMouseUp={stopDrawing}
                                    onMouseLeave={stopDrawing}
                                    onTouchStart={startDrawing}
                                    onTouchMove={draw}
                                    onTouchEnd={stopDrawing}
                                    className="absolute top-0 left-0 w-full h-full cursor-crosshair"
                                    style={{ touchAction: 'none' }}
                                />
                            )}
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-indigo-100 via-purple-50 to-pink-100">
                    <div className="container mx-auto py-8 px-4">
                        <div className="flex justify-between items-center mb-8">
                            <h1 className="text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-600 to-pink-600">
                                Openboard
                            </h1>
                            <div className="flex items-center gap-2 px-4 py-2 bg-white rounded-lg shadow">
                                {isOnline ? (
                                    <>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-green-500"><path d="M5 13a10 10 0 0 1 14 0"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M2 8.82a15 15 0 0 1 20 0"/><line x1="12" x2="12.01" y1="20" y2="20"/></svg>
                                        <span className="text-sm font-medium text-green-700">Online</span>
                                    </>
                                ) : (
                                    <>
                                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><path d="M12 20h.01"/><path d="M8.5 16.5a5 5 0 0 1 7 0"/><path d="M5 13a10 10 0 0 1 14 0"/><path d="m2 8.82 20-.03"/><line x1="2" x2="22" y1="2" y2="22"/></svg>
                                        <span className="text-sm font-medium text-red-700">Offline</span>
                                    </>
                                )}
                            </div>
                        </div>

                        <div className="flex gap-6">
                            {!showAllIdeas && (
                                <div className="w-64 bg-white rounded-lg shadow-lg p-4">
                                    <h3 className="text-xl font-bold mb-4 text-gray-800">Gruppi</h3>
                                    <div className="space-y-2">
                                        {groups.map(group => (
                                            <button
                                                key={group.id}
                                                onClick={() => setSelectedGroup(group.id)}
                                                className={`w-full text-left p-3 rounded-lg transition flex items-center gap-3 ${
                                                    selectedGroup === group.id
                                                        ? 'bg-blue-100 border-2 border-blue-500'
                                                        : 'bg-gray-50 hover:bg-gray-100 border-2 border-transparent'
                                                }`}
                                            >
                                                <span className={`w-4 h-4 rounded-full ${group.color}`}></span>
                                                <span className="font-medium">{group.name}</span>
                                                <span className="ml-auto text-sm text-gray-500">
                                                    {ideas[group.id]?.length || 0}
                                                </span>
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            {selectedGroup && !showAllIdeas && renderGroupView()}
                            {showAllIdeas && renderAllIdeasView()}
                            {!selectedGroup && !showAllIdeas && (
                                <div className="flex-1 flex items-center justify-center">
                                    <div className="text-center text-gray-500">
                                        <p className="text-2xl mb-2">ðŸ‘ˆ Seleziona un gruppo per iniziare</p>
                                        <p className="text-lg">oppure</p>
                                        <button
                                            onClick={() => setShowAllIdeas(true)}
                                            className="mt-4 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2 mx-auto"
                                        >
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>
                                            Vedi tutte le idee
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<Openboard />, document.getElementById('root'));
    </script>
</body>
</html>
